# EV Charging Simulation - Extended Configuration
# 25+ services for comprehensive autonomous testing
# No user interaction required - fully autonomous operation
# 
# AUTONOMOUS OPERATION:
# - 10 Charging Points (CP-001 to CP-010) with diverse power ratings
# - 10 Health Monitors (one per CP)
# - 5 Driver clients with different request intervals
# - 1 Central Controller with web dashboard
# - 1 Kafka message broker
#
# OBSERVABILITY:
# - All terminals show clear, colored output
# - Central: Request routing, CP status, session management
# - CP Engines: State transitions, telemetry, charging sessions
# - CP Monitors: Health checks, fault detection, recovery
# - Drivers: Request status, charging progress, completion
#
# STARTUP: docker compose up -d
# LOGS: docker compose logs -f [service-name]
# DASHBOARD: http://localhost:8000
# STOP: docker compose down

services:
  # ========== INFRASTRUCTURE ==========
  
  # Kafka Message Broker
  kafka:
    image: apache/kafka:3.7.0
    container_name: ev-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      # For local docker-compose: use 'kafka' hostname so containers can connect
      # For lab deployment: set KAFKA_ADVERTISED_HOST=<machine-ip> environment variable
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://${KAFKA_ADVERTISED_HOST:-kafka}:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - evcharging-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========== CENTRAL CONTROLLER ==========
  
  ev-central:
    build:
      context: .
      dockerfile: docker/Dockerfile.central
    container_name: ev-central
    ports:
      - "8000:8000"  # HTTP Dashboard
      - "9999:9999"  # TCP Control
    environment:
      SERVICE_TYPE: central
      CENTRAL_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      CENTRAL_HTTP_PORT: 8000
      CENTRAL_LISTEN_PORT: 9999
      CENTRAL_SECURITY_PORT: 9000
      CENTRAL_LOG_LEVEL: INFO
      EV_SECURITY_SECRET: ${EV_SECURITY_SECRET}
      EV_KEY_ENCRYPTION_SECRET: ${EV_KEY_ENCRYPTION_SECRET:-lab-env-key-encryption-secret-min32chars}
      # Enable Kafka message encryption (set to "true" in production)
      EV_KAFKA_ENCRYPTION: ${EV_KAFKA_ENCRYPTION:-false}
      EV_CP_001_ENCRYPTION_KEY: ${EV_CP_001_ENCRYPTION_KEY:-}
      EV_CP_002_ENCRYPTION_KEY: ${EV_CP_002_ENCRYPTION_KEY:-}
      EV_CP_003_ENCRYPTION_KEY: ${EV_CP_003_ENCRYPTION_KEY:-}
      EV_CP_004_ENCRYPTION_KEY: ${EV_CP_004_ENCRYPTION_KEY:-}
      EV_CP_005_ENCRYPTION_KEY: ${EV_CP_005_ENCRYPTION_KEY:-}
    volumes:
      - data:/data
      - ./certs:/certs:ro
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - evcharging-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('https://localhost:8000/health', context=__import__('ssl')._create_unverified_context())"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========== EV REGISTRY (Release 2) ==========
  
  ev-registry:
    build:
      context: .
      dockerfile: docker/Dockerfile.registry
    container_name: ev-registry
    ports:
      - "8080:8080"  # REST API
    environment:
      REGISTRY_API_PORT: 8080
      REGISTRY_DB_PATH: /data/ev_charging.db
      REGISTRY_LOG_LEVEL: INFO
      REGISTRY_TOKEN_EXPIRATION_HOURS: 24
      # SECURITY: Must set strong secret key via environment variable
      # Generate with: openssl rand -hex 32
      REGISTRY_SECRET_KEY: ${REGISTRY_SECRET_KEY}
      REGISTRY_JWT_ISSUER: "ev-registry"
      REGISTRY_JWT_AUDIENCE: "ev-central"
      # TLS Configuration (required for production)
      REGISTRY_TLS_ENABLED: "${REGISTRY_TLS_ENABLED:-false}"
      REGISTRY_ALLOW_INSECURE: "${REGISTRY_ALLOW_INSECURE:-true}"
      REGISTRY_TLS_CERT_FILE: "${REGISTRY_TLS_CERT_FILE:-}"
      REGISTRY_TLS_KEY_FILE: "${REGISTRY_TLS_KEY_FILE:-}"
      # Certificate Authentication (optional)
      REGISTRY_REQUIRE_CERTIFICATE: "${REGISTRY_REQUIRE_CERTIFICATE:-false}"
      # Admin API Key for re-registration (optional but recommended)
      REGISTRY_ADMIN_API_KEY: "${REGISTRY_ADMIN_API_KEY:-}"
    volumes:
      - data:/data
      # Mount certificates if TLS is enabled
      - ./certs:/certs:ro
      - ./certs:/certs:ro
    networks:
      - evcharging-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('https://localhost:8080/', context=__import__('ssl')._create_unverified_context())"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  
  # ========== WEATHER SERVICE ==========

  ev-weather:
    build:
      context: .
      dockerfile: docker/Dockerfile.weather
    container_name: ev-weather
    ports:
      - "8003:8003"  # Weather API endpoint
    environment:
      OPENWEATHER_API_KEY: ${OPENWEATHER_API_KEY}
      WEATHER_CENTRAL_HTTP_URL: ${CENTRAL_HTTP_URL:-https://ev-central}
      WEATHER_CENTRAL_PORT: ${CENTRAL_HTTP_PORT:-8000}
      WEATHER_POLL_INTERVAL: ${WEATHER_POLLING_INTERVAL:-4}
      WEATHER_CITY_FILE: ${CITY_FILE:-/app/evcharging/common/CP_cities.txt}
      WEATHER_LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      ev-central:
        condition: service_healthy
    networks:
      - evcharging-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========== CHARGING POINT ENGINES (5 CPs) ==========
  # Note: Each CP_E has its own unique encryption key for secure Kafka communication
  # Keys are loaded from EV_CP_ENCRYPTION_KEY env var or keys/{CP_ID}.key file
  # Set EV_KAFKA_ENCRYPTION=true to enable encryption (default: false for lab)
  
  ev-cp-e-1:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_e
    container_name: ev-cp-e-1
    environment:
      CP_ENGINE_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      CP_ENGINE_CP_ID: CP-001
      CP_ENGINE_HEALTH_PORT: 8001
      CP_ENGINE_LOG_LEVEL: INFO
      CP_ENGINE_KW_RATE: 22.0
      CP_ENGINE_EURO_RATE: 0.30
      CP_ENGINE_TELEMETRY_INTERVAL: 1.0
      # Kafka encryption (set to "true" in production)
      EV_KAFKA_ENCRYPTION: ${EV_KAFKA_ENCRYPTION:-false}
      # Per-CP unique encryption key (base64 encoded) - each CP has different key
      EV_CP_ENCRYPTION_KEY: ${EV_CP_001_ENCRYPTION_KEY:-}
    depends_on:
      kafka:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-e-2:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_e
    container_name: ev-cp-e-2
    environment:
      CP_ENGINE_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      CP_ENGINE_CP_ID: CP-002
      CP_ENGINE_HEALTH_PORT: 8002
      CP_ENGINE_LOG_LEVEL: INFO
      CP_ENGINE_KW_RATE: 50.0
      CP_ENGINE_EURO_RATE: 0.35
      CP_ENGINE_TELEMETRY_INTERVAL: 1.0
      # Kafka encryption (set to "true" in production)
      EV_KAFKA_ENCRYPTION: ${EV_KAFKA_ENCRYPTION:-false}
      # Per-CP unique encryption key (base64 encoded) - each CP has different key
      EV_CP_ENCRYPTION_KEY: ${EV_CP_002_ENCRYPTION_KEY:-}
    depends_on:
      kafka:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-e-3:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_e
    container_name: ev-cp-e-3
    environment:
      CP_ENGINE_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      CP_ENGINE_CP_ID: CP-003
      CP_ENGINE_HEALTH_PORT: 8003
      CP_ENGINE_LOG_LEVEL: INFO
      CP_ENGINE_KW_RATE: 43.0
      CP_ENGINE_EURO_RATE: 0.32
      CP_ENGINE_TELEMETRY_INTERVAL: 1.0
      EV_CP_ENCRYPTION_KEY: ${EV_CP_003_ENCRYPTION_KEY:-}
    depends_on:
      kafka:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-e-4:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_e
    container_name: ev-cp-e-4
    environment:
      CP_ENGINE_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      CP_ENGINE_CP_ID: CP-004
      CP_ENGINE_HEALTH_PORT: 8004
      CP_ENGINE_LOG_LEVEL: INFO
      CP_ENGINE_KW_RATE: 150.0
      CP_ENGINE_EURO_RATE: 0.40
      CP_ENGINE_TELEMETRY_INTERVAL: 1.0
      EV_CP_ENCRYPTION_KEY: ${EV_CP_004_ENCRYPTION_KEY:-}
    depends_on:
      kafka:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-e-5:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_e
    container_name: ev-cp-e-5
    environment:
      CP_ENGINE_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      CP_ENGINE_CP_ID: CP-005
      CP_ENGINE_HEALTH_PORT: 8005
      CP_ENGINE_LOG_LEVEL: INFO
      CP_ENGINE_KW_RATE: 7.2
      CP_ENGINE_EURO_RATE: 0.28
      CP_ENGINE_TELEMETRY_INTERVAL: 1.0
      EV_CP_ENCRYPTION_KEY: ${EV_CP_005_ENCRYPTION_KEY:-}
    depends_on:
      kafka:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  # ========== CHARGING POINT MONITORS (10 Monitors) ==========
  
  ev-cp-m-1:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_m
    container_name: ev-cp-m-1
    environment:
      CP_MONITOR_CP_ID: CP-001
      CP_MONITOR_CP_E_HOST: ev-cp-e-1
      CP_MONITOR_CP_E_PORT: 8001
      CP_MONITOR_CP_API_PORT: 9001
      CP_MONITOR_CENTRAL_HOST: ${CENTRAL_HOST:-ev-central}
      CP_MONITOR_CENTRAL_PORT: ${CENTRAL_PORT:-8000}
      CP_MONITOR_HEALTH_INTERVAL: 2.0
      CP_MONITOR_LOG_LEVEL: INFO
      CP_MONITOR_REGISTRY_URL: ${REGISTRY_URL:-https://ev-registry:8080}
      CP_MONITOR_REGISTRY_ADMIN_API_KEY: ${REGISTRY_ADMIN_API_KEY}
      EV_CP_001_ENCRYPTION_KEY: ${EV_CP_001_ENCRYPTION_KEY:-}
    depends_on:
      - ev-central
      - ev-cp-e-1
    ports:
      - "9001:9001"
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-m-2:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_m
    container_name: ev-cp-m-2
    environment:
      CP_MONITOR_CP_ID: CP-002
      CP_MONITOR_CP_E_HOST: ev-cp-e-2
      CP_MONITOR_CP_E_PORT: 8002
      CP_MONITOR_CP_API_PORT: 9002
      CP_MONITOR_CENTRAL_HOST: ${CENTRAL_HOST:-ev-central}
      CP_MONITOR_CENTRAL_PORT: ${CENTRAL_PORT:-8000}
      CP_MONITOR_HEALTH_INTERVAL: 2.0
      CP_MONITOR_LOG_LEVEL: INFO
      CP_MONITOR_REGISTRY_URL: ${REGISTRY_URL:-https://ev-registry:8080}
      CP_MONITOR_REGISTRY_ADMIN_API_KEY: ${REGISTRY_ADMIN_API_KEY}
      EV_CP_002_ENCRYPTION_KEY: ${EV_CP_002_ENCRYPTION_KEY:-}
    depends_on:
      - ev-central
      - ev-cp-e-2
    ports:
      - "9002:9002"
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-m-3:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_m
    container_name: ev-cp-m-3
    environment:
      CP_MONITOR_CP_ID: CP-003
      CP_MONITOR_CP_E_HOST: ev-cp-e-3
      CP_MONITOR_CP_E_PORT: 8003
      CP_MONITOR_CP_API_PORT: 9003
      CP_MONITOR_CENTRAL_HOST: ${CENTRAL_HOST:-ev-central}
      CP_MONITOR_CENTRAL_PORT: ${CENTRAL_PORT:-8000}
      CP_MONITOR_HEALTH_INTERVAL: 2.0
      CP_MONITOR_LOG_LEVEL: INFO
      CP_MONITOR_REGISTRY_URL: ${REGISTRY_URL:-https://ev-registry:8080}
      CP_MONITOR_REGISTRY_ADMIN_API_KEY: ${REGISTRY_ADMIN_API_KEY}
      EV_CP_003_ENCRYPTION_KEY: ${EV_CP_003_ENCRYPTION_KEY:-}
    depends_on:
      - ev-central
      - ev-cp-e-3
    ports:
      - "9003:9003"
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-m-4:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_m
    container_name: ev-cp-m-4
    environment:
      CP_MONITOR_CP_ID: CP-004
      CP_MONITOR_CP_E_HOST: ev-cp-e-4
      CP_MONITOR_CP_E_PORT: 8004
      CP_MONITOR_CP_API_PORT: 9004
      CP_MONITOR_CENTRAL_HOST: ${CENTRAL_HOST:-ev-central}
      CP_MONITOR_CENTRAL_PORT: ${CENTRAL_PORT:-8000}
      CP_MONITOR_HEALTH_INTERVAL: 2.0
      CP_MONITOR_LOG_LEVEL: INFO
      CP_MONITOR_REGISTRY_URL: ${REGISTRY_URL:-https://ev-registry:8080}
      CP_MONITOR_REGISTRY_ADMIN_API_KEY: ${REGISTRY_ADMIN_API_KEY}
      EV_CP_004_ENCRYPTION_KEY: ${EV_CP_004_ENCRYPTION_KEY:-}
    depends_on:
      - ev-central
      - ev-cp-e-4
    ports:
      - "9004:9004"
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-cp-m-5:
    build:
      context: .
      dockerfile: docker/Dockerfile.cp_m
    container_name: ev-cp-m-5
    environment:
      CP_MONITOR_CP_ID: CP-005
      CP_MONITOR_CP_E_HOST: ev-cp-e-5
      CP_MONITOR_CP_E_PORT: 8005
      CP_MONITOR_CP_API_PORT: 9005
      CP_MONITOR_CENTRAL_HOST: ${CENTRAL_HOST:-ev-central}
      CP_MONITOR_CENTRAL_PORT: ${CENTRAL_PORT:-8000}
      CP_MONITOR_HEALTH_INTERVAL: 2.0
      CP_MONITOR_LOG_LEVEL: INFO
      CP_MONITOR_REGISTRY_URL: ${REGISTRY_URL:-https://ev-registry:8080}
      CP_MONITOR_REGISTRY_ADMIN_API_KEY: ${REGISTRY_ADMIN_API_KEY}
      EV_CP_005_ENCRYPTION_KEY: ${EV_CP_005_ENCRYPTION_KEY:-}
    depends_on:
      - ev-central
      - ev-cp-e-5
    ports:
      - "9005:9005"
    networks:
      - evcharging-network
    restart: unless-stopped

  # ========== DRIVER CLIENTS (5 Drivers) ==========
  
  ev-driver-alice:
    build:
      context: .
      dockerfile: docker/Dockerfile.driver
    container_name: ev-driver-alice
    environment:
      DRIVER_DRIVER_ID: driver-alice
      DRIVER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      DRIVER_REQUEST_INTERVAL: 120.0
      DRIVER_LOG_LEVEL: INFO
      DRIVER_DASHBOARD_PORT: 8100
      DRIVER_CENTRAL_HTTPS_URL: ${CENTRAL_HTTP_URL:-https://ev-central:8000}
      DRIVER_AUTO_RUN_REQUESTS: "false"
    volumes:
      - ./requests.txt:/app/requests.txt:ro
    ports:
      - "8100:8100"
    depends_on:
      kafka:
        condition: service_started
      ev-central:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-driver-bob:
    build:
      context: .
      dockerfile: docker/Dockerfile.driver
    container_name: ev-driver-bob
    environment:
      DRIVER_DRIVER_ID: driver-bob
      DRIVER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      DRIVER_REQUEST_INTERVAL: 60.0
      DRIVER_LOG_LEVEL: INFO
      DRIVER_DASHBOARD_PORT: 8101
      DRIVER_CENTRAL_HTTP_URL: ${CENTRAL_HTTP_URL:-https://ev-central:8000}
      DRIVER_AUTO_RUN_REQUESTS: "false"
    volumes:
      - ./requests.txt:/app/requests.txt:ro
    ports:
      - "8101:8101"
    depends_on:
      kafka:
        condition: service_started
      ev-central:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-driver-charlie:
    build:
      context: .
      dockerfile: docker/Dockerfile.driver
    container_name: ev-driver-charlie
    environment:
      DRIVER_DRIVER_ID: driver-charlie
      DRIVER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      DRIVER_REQUEST_INTERVAL: 30.0
      DRIVER_LOG_LEVEL: INFO
      DRIVER_DASHBOARD_PORT: 8102
      DRIVER_CENTRAL_HTTP_URL: ${CENTRAL_HTTP_URL:-https://ev-central:8000}
      DRIVER_AUTO_RUN_REQUESTS: "false"
    volumes:
      - ./requests.txt:/app/requests.txt:ro
    ports:
      - "8102:8102"
    depends_on:
      kafka:
        condition: service_started
      ev-central:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-driver-david:
    build:
      context: .
      dockerfile: docker/Dockerfile.driver
    container_name: ev-driver-david
    environment:
      DRIVER_DRIVER_ID: driver-david
      DRIVER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      DRIVER_REQUEST_INTERVAL: 15.0
      DRIVER_LOG_LEVEL: INFO
      DRIVER_DASHBOARD_PORT: 8103
      DRIVER_CENTRAL_HTTP_URL: ${CENTRAL_HTTP_URL:-https://ev-central:8000}
      DRIVER_AUTO_RUN_REQUESTS: "false"
    volumes:
      - ./requests.txt:/app/requests.txt:ro
    ports:
      - "8103:8103"
    depends_on:
      kafka:
        condition: service_started
      ev-central:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

  ev-driver-eve:
    build:
      context: .
      dockerfile: docker/Dockerfile.driver
    container_name: ev-driver-eve
    environment:
      DRIVER_DRIVER_ID: driver-eve
      DRIVER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP:-kafka:9092}
      DRIVER_REQUEST_INTERVAL: 10.0
      DRIVER_LOG_LEVEL: INFO
      DRIVER_DASHBOARD_PORT: 8104
      DRIVER_CENTRAL_HTTP_URL: ${CENTRAL_HTTP_URL:-https://ev-central:8000}
      DRIVER_AUTO_RUN_REQUESTS: "false"
    volumes:
      - ./requests.txt:/app/requests.txt:ro
    ports:
      - "8104:8104"
    depends_on:
      kafka:
        condition: service_started
      ev-central:
        condition: service_started
    networks:
      - evcharging-network
    restart: unless-stopped

networks:
  evcharging-network:
    driver: bridge

volumes:
  kafka-data:
  data:
  certs:

