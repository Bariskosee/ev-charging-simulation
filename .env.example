# Environment variables for EV Charging Simulation
# Copy this file to .env and adjust values as needed

# ============================================
# DEPLOYMENT SCENARIOS
# ============================================

# Scenario 1: Full Local (Default)
# - All services including Kafka on same machine
# - Use defaults below (no .env needed)

# Scenario 2: Remote Kafka
# - Uncomment and set KAFKA_BOOTSTRAP to remote server
# KAFKA_BOOTSTRAP=kafka.example.com:9092

# Scenario 3: Lab Machines (Distributed)
# - Set KAFKA_BOOTSTRAP and service hosts appropriately
# KAFKA_BOOTSTRAP=192.168.1.10:9092
# CENTRAL_HOST=192.168.1.10

# ============================================
# SERVICE CONFIGURATIONS
# ============================================

# ===== Central Configuration =====
CENTRAL_KAFKA_BOOTSTRAP=localhost:9092
CENTRAL_HTTP_PORT=8000
CENTRAL_LISTEN_PORT=9999
CENTRAL_LOG_LEVEL=INFO
# CENTRAL_DB_URL=sqlite:///evcharging.db  # Optional database

# ===== CP Engine Configuration =====
CP_ENGINE_KAFKA_BOOTSTRAP=localhost:9092
# CP_ENGINE_CP_ID will be set per instance via docker-compose
CP_ENGINE_HEALTH_PORT=8001
CP_ENGINE_LOG_LEVEL=INFO
CP_ENGINE_TELEMETRY_INTERVAL=1.0
CP_ENGINE_KW_RATE=22.0
CP_ENGINE_EURO_RATE=0.30

# ===== CP Monitor Configuration =====
# CP_MONITOR_CP_ID will be set per instance via docker-compose
CP_MONITOR_CP_E_HOST=localhost
CP_MONITOR_CP_E_PORT=8001
CP_MONITOR_CENTRAL_HOST=localhost
CP_MONITOR_CENTRAL_PORT=8000
CP_MONITOR_HEALTH_INTERVAL=1.0
CP_MONITOR_LOG_LEVEL=INFO

# ===== Driver Configuration =====
# DRIVER_DRIVER_ID will be set via docker-compose
DRIVER_KAFKA_BOOTSTRAP=localhost:9092
DRIVER_REQUEST_INTERVAL=4.0
DRIVER_LOG_LEVEL=INFO
# DRIVER_REQUESTS_FILE=requests.txt  # Optional

# ============================================
# LAB DEPLOYMENT EXAMPLES
# ============================================

# Example 1: Connect to remote Kafka
# KAFKA_BOOTSTRAP=kafka.lab.edu:9092
# CENTRAL_KAFKA_BOOTSTRAP=kafka.lab.edu:9092
# CP_ENGINE_KAFKA_BOOTSTRAP=kafka.lab.edu:9092
# DRIVER_KAFKA_BOOTSTRAP=kafka.lab.edu:9092

# Example 2: Connect charging points to remote Central
# CP_MONITOR_CENTRAL_HOST=central.lab.edu
# CP_MONITOR_CENTRAL_PORT=8000

# Example 3: Full distributed setup
# KAFKA_BOOTSTRAP=192.168.1.10:9092
# CP_MONITOR_CENTRAL_HOST=192.168.1.10
# CP_MONITOR_CP_E_HOST=192.168.1.11

# ============================================
# EV_REGISTRY SECURITY CONFIGURATION
# ============================================

# ===== CRITICAL: Required Security Settings =====

# JWT Secret Key (REQUIRED - no default for security)
# Generate with: openssl rand -hex 32
# Minimum 32 characters required
REGISTRY_SECRET_KEY=your-secret-key-here-please-generate-with-openssl

# Admin API Key (REQUIRED for re-registration and privileged ops)
# Generate with: openssl rand -hex 32
REGISTRY_ADMIN_API_KEY=your-admin-key-here-please-generate-with-openssl

# ===== TLS/HTTPS Configuration =====

# TLS enabled by default (secure-by-default)
REGISTRY_TLS_ENABLED=true

# TLS Certificate files (required when TLS enabled)
REGISTRY_TLS_CERT_FILE=/certs/cert.pem
REGISTRY_TLS_KEY_FILE=/certs/key.pem

# Generate self-signed cert (development):
#   openssl req -x509 -newkey rsa:4096 \
#     -keyout certs/key.pem -out certs/cert.pem \
#     -days 365 -nodes -subj "/CN=ev-registry"
#
# Production: Use Let's Encrypt or CA-signed certificates

# ===== Development Mode (UNSAFE - Local Dev Only) =====

# Allow insecure mode (HTTP instead of HTTPS)
# WARNING: Only set to true for local development
# Production deployments MUST leave this false
REGISTRY_ALLOW_INSECURE=false

# ===== Optional Security Settings =====

# Require client certificate authentication
# When true, CPs must present valid certificates
REGISTRY_REQUIRE_CERTIFICATE=false

# JWT Configuration
REGISTRY_JWT_ISSUER=ev-registry
REGISTRY_JWT_AUDIENCE=ev-central
REGISTRY_JWT_EXPIRATION=86400  # 24 hours in seconds

# ===== Registry Server Configuration =====
REGISTRY_HOST=0.0.0.0
REGISTRY_PORT=8080
REGISTRY_LOG_LEVEL=INFO

# Database (shared with EV_Central)
REGISTRY_DB_URL=sqlite:////data/ev_registry.db

# ============================================
# SECURITY HARDENING GUIDE
# ============================================

# Step 1: Generate strong secrets
#   openssl rand -hex 32 > registry_secret.txt
#   openssl rand -hex 32 > admin_key.txt
#
# Step 2: Generate TLS certificates
#   mkdir -p certs
#   openssl req -x509 -newkey rsa:4096 \
#     -keyout certs/key.pem -out certs/cert.pem \
#     -days 365 -nodes -subj "/CN=ev-registry"
#
# Step 3: Set environment variables
#   export REGISTRY_SECRET_KEY=$(cat registry_secret.txt)
#   export REGISTRY_ADMIN_API_KEY=$(cat admin_key.txt)
#
# Step 4: Mount certificates in docker-compose.yml
#   volumes:
#     - ./certs/cert.pem:/certs/cert.pem:ro
#     - ./certs/key.pem:/certs/key.pem:ro
#
# Step 5: Verify TLS is working
#   curl https://localhost:8080/

# ============================================
# SECURITY FEATURES IMPLEMENTED
# ============================================

# ✅ Re-registration protection
#    - Requires X-Existing-Credentials or X-Registry-API-Key header
#    - Prevents credential takeover attacks
#
# ✅ Certificate enforcement
#    - Validates X-Client-Cert-Fingerprint when required
#    - Fingerprints stored with registration
#
# ✅ TLS by default
#    - Enabled by default, requires explicit allow_insecure flag
#    - Fails fast if TLS config incomplete
#
# ✅ Strong secret requirements
#    - No default secret key (must be provided)
#    - Minimum 32 character length enforced
#
# ✅ Error normalization
#    - All auth failures return 401 (no information leakage)
#    - Generic "Authentication failed" message
#
# ✅ JWT issuer/audience validation
#    - iss="ev-registry", aud="ev-central"
#    - Full validation on token verification

# ============================================
# PRODUCTION DEPLOYMENT CHECKLIST
# ============================================

# [ ] Generate strong REGISTRY_SECRET_KEY (openssl rand -hex 32)
# [ ] Generate strong REGISTRY_ADMIN_API_KEY (openssl rand -hex 32)
# [ ] Generate or obtain TLS certificates
# [ ] Set REGISTRY_TLS_ENABLED=true
# [ ] Set REGISTRY_ALLOW_INSECURE=false
# [ ] Mount certificate files in Docker volumes
# [ ] Update CP Monitor to use https:// URLs
# [ ] Test re-registration protection
# [ ] Verify certificate validation (if enabled)
# [ ] Monitor logs for security events

# For detailed security documentation, see:
#   - EV_REGISTRY_SECURITY.md (comprehensive security guide)
#   - EV_REGISTRY_README.md (API reference)
#   - EV_REGISTRY_IMPLEMENTATION.md (architecture details)
